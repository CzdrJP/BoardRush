--[[
    ScoreClient.client.lua
    -----------------------
    ç”»é¢å³ä¸Šã«ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã™ã‚‹UIã€‚
    player:GetAttribute("TrickScore") ã®å¤‰åŒ–ã‚’ç›£è¦–ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã€‚
    TrickEnded ã‚¤ãƒ™ãƒ³ãƒˆã§ç²å¾—ã‚¹ã‚³ã‚¢ã‚’ã‚­ãƒ£ãƒ©é ­ä¸Šã«ãƒãƒƒãƒ—è¡¨ç¤ºã€‚
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

---------------------------------------------------------------------------
-- Remotes
---------------------------------------------------------------------------
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local TrickEnded = Remotes:WaitForChild("TrickEnded")

---------------------------------------------------------------------------
-- UIä½œæˆï¼ˆãƒªã‚¹ãƒãƒ¼ãƒ³æ™‚ã®é‡è¤‡é˜²æ­¢: å¤ã„GUIã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆï¼‰
---------------------------------------------------------------------------
local playerGui = player:WaitForChild("PlayerGui")
local oldGui = playerGui:FindFirstChild("ScoreGui")
if oldGui then
    oldGui:Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ScoreGui"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.DisplayOrder = 10
screenGui.Parent = playerGui

-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆå³ä¸Šï¼‰
local scoreFrame = Instance.new("Frame")
scoreFrame.Name = "ScoreFrame"
scoreFrame.Size = UDim2.new(0, 220, 0, 70)
scoreFrame.Position = UDim2.new(1, -20, 0, 20)
scoreFrame.AnchorPoint = Vector2.new(1, 0)
scoreFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
scoreFrame.BackgroundTransparency = 0.3
scoreFrame.BorderSizePixel = 0
scoreFrame.Parent = screenGui

local scoreCorner = Instance.new("UICorner")
scoreCorner.CornerRadius = UDim.new(0, 12)
scoreCorner.Parent = scoreFrame

local scoreStroke = Instance.new("UIStroke")
scoreStroke.Color = Color3.fromRGB(255, 200, 50)
scoreStroke.Thickness = 2
scoreStroke.Transparency = 0.3
scoreStroke.Parent = scoreFrame

-- "ğŸ’° MONEY" ãƒ©ãƒ™ãƒ«
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "TitleLabel"
titleLabel.Size = UDim2.new(1, -16, 0, 24)
titleLabel.Position = UDim2.new(0, 8, 0, 6)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "ğŸ’° MONEY"
titleLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
titleLabel.TextSize = 20
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = scoreFrame

-- ã‚¹ã‚³ã‚¢å€¤
local scoreLabel = Instance.new("TextLabel")
scoreLabel.Name = "ScoreLabel"
scoreLabel.Size = UDim2.new(1, -16, 0, 34)
scoreLabel.Position = UDim2.new(0, 8, 0, 28)
scoreLabel.BackgroundTransparency = 1
scoreLabel.Text = "0"
scoreLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
scoreLabel.TextSize = 32
scoreLabel.Font = Enum.Font.GothamBlack
scoreLabel.TextXAlignment = Enum.TextXAlignment.Right
scoreLabel.Parent = scoreFrame

---------------------------------------------------------------------------
-- ã‚¹ã‚³ã‚¢æ›´æ–°
---------------------------------------------------------------------------
local isDrainAnimating = false -- å‰æ–¹å®£è¨€ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¼”å‡ºã§ä½¿ç”¨ï¼‰

local function updateScore()
    if isDrainAnimating then return end -- ã‚¢ãƒ‹ãƒ¡ä¸­ã¯æ›´æ–°ã—ãªã„
    local score = player:GetAttribute("TrickScore") or 0
    scoreLabel.Text = tostring(score)
end

-- åˆæœŸè¡¨ç¤º
updateScore()

-- å±æ€§å¤‰æ›´ã‚’ç›£è¦–
player:GetAttributeChangedSignal("TrickScore"):Connect(updateScore)

---------------------------------------------------------------------------
-- ç²å¾—ã‚¹ã‚³ã‚¢æ¼”å‡ºï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é ­ä¸Šã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰
---------------------------------------------------------------------------
local function showEarnedScore(amount: number)
    if amount <= 0 then return end
    
    local character = player.Character
    if not character then return end
    local head = character:FindFirstChild("Head")
    if not head then return end
    
    -- BillboardGui ã‚’ã‚­ãƒ£ãƒ©é ­ä¸Šã«ä½œæˆï¼ˆã‚¹ã‚³ã‚¢ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "EarnedScorePopup"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 200, 0, 60)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head
    
    local label = Instance.new("TextLabel")
    label.Name = "PopupLabel"
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = "+" .. tostring(amount) .. "ğŸ’°!"
    label.TextColor3 = Color3.fromRGB(255, 220, 50)
    label.TextStrokeColor3 = Color3.fromRGB(40, 20, 0)
    label.TextStrokeTransparency = 0.3
    label.TextSize = 32
    label.Font = Enum.Font.GothamBlack
    label.TextTransparency = 0
    label.Parent = billboard
    
    -- ä¸Šã«æµ®ã‹ã³ãªãŒã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    local tweenInfo = TweenInfo.new(2.0, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    TweenService:Create(billboard, tweenInfo, {
        StudsOffset = Vector3.new(0, 8, 0)
    }):Play()
    TweenService:Create(label, tweenInfo, {
        TextTransparency = 1,
        TextStrokeTransparency = 1
    }):Play()
    
    -- æ¼”å‡ºçµ‚äº†å¾Œã«å‰Šé™¤
    task.delay(2.1, function()
        if billboard and billboard.Parent then
            billboard:Destroy()
        end
    end)
    
    -- ğŸ’° ã‚³ã‚¤ãƒ³æ•£ã‚‰ã°ã‚Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆGUIï¼‰
    local camera = workspace.CurrentCamera
    local screenPos, onScreen = camera:WorldToScreenPoint(head.Position)
    if not onScreen then return end
    
    local COIN_COUNT = 12
    local COIN_EMOJIS = {"ğŸ’°", "ğŸ’µ", "ğŸ’°", "ğŸ’µ", "ğŸ’°", "ğŸ’µ"}
    
    for i = 1, COIN_COUNT do
        local coin = Instance.new("TextLabel")
        coin.Name = "CoinEffect_" .. i
        coin.Size = UDim2.new(0, 30, 0, 30)
        coin.Position = UDim2.new(0, screenPos.X - 15, 0, screenPos.Y - 15)
        coin.BackgroundTransparency = 1
        coin.Text = COIN_EMOJIS[math.random(1, #COIN_EMOJIS)]
        coin.TextSize = math.random(18, 28)
        coin.Font = Enum.Font.GothamBold
        coin.TextTransparency = 0
        coin.ZIndex = 100
        coin.Parent = screenGui
        
        -- ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«é£›ã°ã™
        local angle = (i / COIN_COUNT) * math.pi * 2 + math.random() * 0.5
        local dist = math.random(80, 180)
        local endX = screenPos.X - 15 + math.cos(angle) * dist
        local endY = screenPos.Y - 15 + math.sin(angle) * dist - math.random(30, 80) -- ä¸Šæ–¹å‘ãƒã‚¤ã‚¢ã‚¹
        
        local coinTween = TweenInfo.new(
            0.8 + math.random() * 0.6, -- 0.8~1.4ç§’
            Enum.EasingStyle.Quad,
            Enum.EasingDirection.Out
        )
        TweenService:Create(coin, coinTween, {
            Position = UDim2.new(0, endX, 0, endY),
            TextTransparency = 1,
            Rotation = math.random(-180, 180)
        }):Play()
        
        -- å‰Šé™¤
        task.delay(1.5, function()
            if coin and coin.Parent then
                coin:Destroy()
            end
        end)
    end
end

---------------------------------------------------------------------------
-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ãƒãƒãƒ¼æ¸›å°‘æ¼”å‡º
---------------------------------------------------------------------------
local function playMoneyDrainAnimation(fromScore: number)
    if fromScore <= 0 then return end
    isDrainAnimating = true
    
    local digits = #tostring(fromScore)
    
    -- UIã‚’å°‘ã—å¤§ããã™ã‚‹æ¼”å‡º
    TweenService:Create(scoreFrame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 260, 0, 82)
    }):Play()
    
    -- ã‚¹ã‚³ã‚¢ãƒ©ãƒ™ãƒ«ã‚’èµ¤ãã™ã‚‹
    TweenService:Create(scoreLabel, TweenInfo.new(0.2), {
        TextColor3 = Color3.fromRGB(255, 80, 80)
    }):Play()
    
    -- ãƒ‘ãƒ©ãƒ‘ãƒ©æ¸›å°‘ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    local totalDuration = 2.0
    local steps = 30
    local stepInterval = totalDuration / steps
    
    task.spawn(function()
        for i = 1, steps do
            -- é€²è¡Œç‡ã«åŸºã¥ã„ãŸå¤§ã¾ã‹ãªæ¸›å°‘
            local progress = i / steps
            local baseValue = math.floor(fromScore * (1 - progress))
            
            -- ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ–ãƒ¬ã‚’åŠ ãˆã‚‹ï¼ˆæ¡æ•°ã¯ç¶­æŒï¼‰
            local maxForDigits = math.pow(10, digits) - 1
            local jitter = math.random(0, math.max(1, math.floor(fromScore * 0.1)))
            local displayed = math.clamp(baseValue + jitter, 0, maxForDigits)
            
            -- æœ€å¾Œã®æ•°ã‚¹ãƒ†ãƒƒãƒ—ã¯0ã«è¿‘ã¥ã‘ã‚‹
            if i >= steps - 3 then
                displayed = math.floor(fromScore * (1 - progress) * math.random() * 0.5)
            end
            if i == steps then
                displayed = 0
            end
            
            -- æ¡æ•°ã‚’åˆã‚ã›ã¦ã‚¼ãƒ­åŸ‹ã‚ï¼ˆæœ€åˆã®æ¡ãŒ0ãªã‚‰é€šå¸¸è¡¨ç¤ºï¼‰
            local text = tostring(displayed)
            
            scoreLabel.Text = text
            task.wait(stepInterval)
        end
        
        -- æœ€çµ‚å€¤ã‚’0ã«ç¢ºå®š
        scoreLabel.Text = "0"
        
        -- UIã‚’å…ƒã®ã‚µã‚¤ã‚ºã«æˆ»ã™
        TweenService:Create(scoreFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 220, 0, 70)
        }):Play()
        
        -- ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æˆ»ã™
        TweenService:Create(scoreLabel, TweenInfo.new(0.5), {
            TextColor3 = Color3.fromRGB(255, 255, 255)
        }):Play()
        
        isDrainAnimating = false
    end)
end

-- TrickEndedãƒãƒ³ãƒ‰ãƒ©
TrickEnded.OnClientEvent:Connect(function(data)
    if data and data.earnedScore and data.earnedScore > 0 then
        showEarnedScore(data.earnedScore)
    end
    
    -- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ãƒãƒãƒ¼æ¸›å°‘æ¼”å‡º
    if data and data.gameOver and data.lostScore and data.lostScore > 0 then
        playMoneyDrainAnimation(data.lostScore)
    end
end)

print("[ScoreClient] Initialized")
